@{
    string reportType = Convert.ToString(ViewBag.ReportType);
}

<link href="@Url.Content("~/Content/css/Select2/select2.css")" rel="stylesheet" />
<script src="~/Scripts/js/Select2/select2.js"></script>

<div class="row-fluid calc-height" id="DivShareReportContainer">
    <div class="span12">
        @*Modified by Sohel on 28th March to remove fixed height of pop-up. height-auto class has been added*@ 
        <div id="modal-container-sharereport" class="form-inspect-share hide fade height-auto" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            @*Modified by Sohel on 3rd April 2014 for PL# 398 to display error message on the top of sharing pop-up, below div has been place inside from outside of main div *@ 
        <div id="errorMessageShareReportPopup" class="alert alert-error hide error-over-modal">
            <a class="close">×</a>
            <strong>Error! </strong><span id="spanMessageErrorShareReportPopup"></span>
        </div>
            @**@
            <div class="login-wrapper">
                <form name="share-report">
                    <h2 class="primary-title source-sans-prosemibold">Share Report</h2>
                    <label>All fields required.</label>
                    <input id="select2Email" type="hidden" name="select2Email" class="input-block-level" style="margin-bottom: 10px;" />
                    <textarea rows="3" placeholder="Add Optional Message" id="TxtOptionalMessage" maxlength="255"></textarea>
                    <span class="attach-icon"></span>
                    <label id="shareReport">@reportType</label>
                    <button class="form-inspect-share-button btn btn-large bottom-margin-popups" type="submit" value="Submit">Share</button>
                    <button id="cancel-share-report-button" class="btn-link Cancel-button-center-popups" type="button">Cancel</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row-fluid calc-height" id="DivShareReportConfirmationContainer">
    <div class="span12">
        @*Modified by Sohel on 28th March to remove fixed height of pop-up. height-auto class has been added*@ 
        <div id="modal-container-confirmation" class="form-inspect-share-confirmation hide fade height-auto" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="login-wrapper">
                <form name="login-register">
                    <h2 class="primary-title source-sans-prosemibold">Report Successfully<br />
                        Shared With</h2>
                    <label id="email-confirmation"></label>
                    @*Modified by Sohel on 1st April 2014 for BTS ticket #153, solved reset data issue on confirmation button click event*@
                    <button class="form-inspect-share-button btn btn-large" id="BtnCloseConfirmation" type="button">Close</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    var select2EmailData = [];

    $(document).ready(function () {
        //// Hide parent div container when popup is closed.
        $("#modal-container-sharereport").on("hide", function (e) { $("#DivShareReport").hide(); });

        $('#modal-container-confirmation').on("hide", function (e) { $("#DivShareReport").hide(); });
        $('#modal-container-confirmation').on("show", function (e) { $("#DivShareReport").show(); });

        //// Show popup.
        $("#modal-container-sharereport").modal('show');

        //// Close popup and error message.
        $('#cancel-share-report-button').on("click", function () {
            $('#modal-container-sharereport').modal("hide");
            $(".alert").find(".close").click();
        });

        //// Close error message.
        $(".alert").find(".close").on("click", function (e) {
            e.stopPropagation();
            e.preventDefault(); 
            $(this).closest(".alert").slideUp(400);
        });	

        //// Populating email id.
        var emails = @Html.Raw(Json.Encode(@ViewBag.EmailIds));
        if (emails != null) {
            $.each(emails, function (index, email) {
                select2EmailData.push({id: email, text: email});
            });
        }

        //// Adding data to select2
        $("#select2Email").select2({
            placeholder: "Email",
            multiple: true,
            data: select2EmailData
        });

        //// Valdiate and Send mail on click of share button of share report popup.
        $('form[name="share-report"]').on("submit", function (e) {
            if ($("#select2Email").select2("val") == "") {
                var msgspan = "@RevenuePlanner.Helpers.Common.objCached.ValidateEmailAtleastone";
                $("#errorMessageShareReportPopup").css("display", "block");
                $(".input-block-level").addClass("error");
                //// Added by Sohel on 2nd April for PL#398 to display validation error properly
                $(".select2-choices").css("background-image", "none");
                $(".select2-choices").addClass("error-background");
                ////
                $("#spanMessageErrorShareReportPopup").text(msgspan);
            }
            ////Commented By Sohel on 2nd April 2014 to remove special character validations that was provided in OptionalMessage textbox. 
            ////// Validating Optional message.
            //else if (/[!@@#$%\^&*(){}[\]<>?/|\-]/.test($("#TxtOptionalMessage").val())) {
            //    var msgspan = "Special character are not allowed, try again.";
            //    $("#errorMessageShareReportPopup").css("display", "block");
            //    $("#TxtOptionalMessage").addClass("error");
            //    $(".input-block-level").removeClass("error");
            //    $("#spanMessageErrorShareReportPopup").text(msgspan);
            //}
            ////
            else {
                $(".input-block-level").removeClass("error");
                ////Modified By Sohel on 2nd April 2014 to remove special character validations that was provided in OptionalMessage textbox. 
                //$("#TxtOptionalMessage").removeClass("error");
                $(".select2-choices").removeClass("error-background");
                $("#errorMessageShareReportPopup").css("display", "none");
                ////
                // Send mail and show confirmation popup.
                ShareReport($("#select2Email").select2("val").toString(), $("#TxtOptionalMessage").val());
            }

            return false;
        });

        //Start Share Report
        function ShareReport(email, optionalMessage) {
            var reportType = '@reportType';
            var htmlOfCurrentView = GetHTML(reportType);
            //// Added by Sohel on 2nd April for PL#398 to encode the text insert in Optional Message Textbox
            optionalMessage = escape(optionalMessage);
            ////
            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: '@Url.Content("~/Report/ShareReport/")',
                data: {
                    reportType: reportType,
                    toEmailIds: email,
                    optionalMessage: optionalMessage,
                    htmlOfCurrentView : htmlOfCurrentView
                },
                success: function (data) {
                    if (data != 'undefined' && data != false) {
                        ////Added by Sohel on 28th March 2014 for Wrapping the emaild ids.
                        email = email.replace(/,/g, ", ");
                        ////
                        ShowConfirmation(email);
                        return false;
                    }
                    else {
                        var msgspan = '@RevenuePlanner.Helpers.Common.objCached.ErrorOccured';
                        $("#errorMessageShareReportPopup").css("display", "block");
                        $("#spanMessageErrorShareReportPopup").text(msgspan);
                    }
                }
            });
        }

        function GetHTML(reportType)
        {
            if (reportType == '@RevenuePlanner.Helpers.Enums.ReportType.Summary.ToString()') {
                return GetHTMLSummary()
            }else if (reportType == '@RevenuePlanner.Helpers.Enums.ReportType.Revenue.ToString()') {
                return GetHTMLRevenue();
            }else if (reportType == '@RevenuePlanner.Helpers.Enums.ReportType.Conversion.ToString()') {
                return GetHTMLConversion();
            }
            else {
                return false;
            }
    }

        /*Modified By Maninder Singh Wadhva on  10/21/2014 for ticket #865 	Custom fields & Report filter - Review changes on reports PDF*/
        function GetHTMLConversion()
        {
            var filterHTML = $('.budgetReportFilter-area-left').parent().parent().html();
            var html = filterHTML;
            var $html = $('<div id="content_wraper" class="span10 all-height" style="width:100%">' + html + '</div></div></div>');
            $html.find('div[id="chartDiv1"]').empty();
            $html.find('div[id="chartDiv2"]').empty();
            $html.find('div[id="chartDiv3"]').empty();
            $html.find("li.disabled > a").each(function(){
                $(this).parent().removeClass("disabled");
                $(this).css("background-color","#E0DFDF");
            });
            $html.find("#table_reports5 tbody tr td").each(function () {
                $(this).css("width", "60px");
            });

            $html.find('.multiselection-area').remove();
            $html.find('.budgetReportFilter-area-right').remove();
            $html.find('div').removeClass("budgetReportFilter-area-left");
            $html.find('#DivShareReportContainer').remove();
            $html.find('#DivShareReportCoknfirmationContainer').remove();
            html = $html.wrap('<p/>').parent().html();
            return escape(html);
        }

        /*Modified By Maninder Singh Wadhva on  10/17/2014 for ticket #865 	Custom fields & Report filter - Review changes on reports PDF*/
        function GetHTMLRevenue()
        {
            var filterHTML = $('.budgetReportFilter-area-left').parent().parent().html();
            var html = filterHTML;
            var $html = $('<div id="content_wraper" class="span10 all-height" style="width:100%">' + html + '</div>');
            $html.find("#table_reports4").before('<div style="width:100%;height:20px;"></div>');
            $html.find("#table_reports2 thead tr th:nth-child(1)").removeClass("width96px").css("width","60px");
            $html.find("#table_reports2 tbody tr td").each(function () {
                $(this).css("width","60px");
            });

            $html.find("li.disabled > a").each(function(){
                $(this).parent().removeClass("disabled");
                $(this).css("background-color","#E0DFDF");
            });

            $html.find("a").each(function(){
                $(this).removeAttr("href");
            });
            
            $html.find("#ddlBusinessUnitSelectBox").parent().css("margin-bottom","10px");            
            $html.find('div[id="chartDiv3"]').empty();
            $html.find('div[id="chartDiv4"]').empty();
            $html.find('div[id="chartDiv5"]').empty();
            $html.find('div[id="chartDiv6"]').empty();
            $html.find('.multiselection-area').remove();
            $html.find('.budgetReportFilter-area-right').remove();
            $html.find('div').removeClass("budgetReportFilter-area-left");
            $html.find('#DivShareReportContainer').remove();
            $html.find('#DivShareReportCoknfirmationContainer').remove();

            html = $html.wrap('<p/>').parent().html();
            return escape(html);
        }

        /*Modified By Maninder Singh Wadhva on  10/17/2014 for ticket #865 	Custom fields & Report filter - Review changes on reports PDF*/
        function GetHTMLSummary(){
            var filterHTML = $('.budgetReportFilter-area-left').parent().parent().html();
            var html  = '';
            html += '<div style="margin-left: 100px;"></br>' + filterHTML + '</div>';
            var $html = $(html);
            $html.find('div[id="chartDiv"]').empty();
            $html.find('#AViewDetailReportRevenue').remove();
            $html.find('#AViewDetailReportConversion').remove();

            $html.find('.multiselection-area').remove();
            $html.find('.budgetReportFilter-area-right').remove();
            $html.find('div').removeClass("budgetReportFilter-area-left");
            $html.find('#DivShareReportContainer').remove();
            $html.find('#DivShareReportCoknfirmationContainer').remove();

            html = $html.html();
            return escape(html);
        }

        //// Close popup and error message.
        $('#BtnCloseConfirmation').on("click", function () {
            $('#modal-container-confirmation').modal("hide");
            $(".alert").find(".close").click();
        });

        $('#modal-container-confirmation').hide();
        function ShowConfirmation(email) {
            $('#modal-container-sharereport').modal("hide");
            $(".alert").find(".close").click();
            $('#email-confirmation').html(email);
            $('#modal-container-confirmation').modal('show');
        }
    });
</script>
