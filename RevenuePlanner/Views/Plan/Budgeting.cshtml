@using RevenuePlanner.Helpers
@{
    ViewBag.Title = ViewBag.ActiveMenu;
    Layout = "~/Views/Shared/_Layout.cshtml";
    ViewBag.Title = "Budgeting";
    ViewBag.PageTitle = "Budgeting";
    //bool showBid = ViewBag.showBid;
    int CurrentPlanId = ViewBag.PlanId;
    bool IsPlanCreateAuthorized = (bool)ViewBag.IsPlanCreateAuthorized;
    string type = Convert.ToString(Request.QueryString["type"]);
    string expand = Convert.ToString(Request.QueryString["expand"]);
    if (string.IsNullOrEmpty(type))
    {
        type = "allocated";
    }
    string sucMsg = Convert.ToString(TempData["SuccessMessage"]);
    TempData["SuccessMessage"] = null;
    string myView = "0";
    if (TempData["ViewBy"] != null)
    {
        myView = Convert.ToString(TempData["ViewBy"]);
        if (string.IsNullOrEmpty(myView))
        {
            myView = "0";
        }
    }
    RevenuePlanner.Models.HomePlan ListBudgetingPlan = ViewBag.budgetPlanList;
}
@section Sidebar
{
    @Html.Partial("~/Views/Plan/_plan.cshtml")
}
@section nlFormContent{
    <link rel="stylesheet" href="@Url.Content("~/Content/css/NaturalLanguageForm/default.css")" type="text/css" />
    <link rel="stylesheet" href="@Url.Content("~/Content/css/NaturalLanguageForm/component.css")" type="text/css" />
    <script type="text/javascript" src="@Url.Content("~/Scripts/js/NaturalLanguageForm/modernizr.custom.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/js/NaturalLanguageForm/nlform.js?n=")@DateTime.Now"></script>
}
<link rel="stylesheet" href="@Url.Content("~/Content/css/jquery.mCustomScrollbar.css")" type="text/css" />
<script type="text/javascript" src="@Url.Content("~/Scripts/js/jquery.slimscroll.js")"></script>
<script type="text/javascript" src="@Url.Content("~/Scripts/js/slimScrollHorizontal.js")"></script>
<script type="text/javascript" src="@Url.Content("~/Scripts/js/jquery.mCustomScrollbar.concat.min.js")"></script>
<script type="text/javascript" src="@Url.Content("~/Scripts/js/jquery.actual.js")"></script>
<style type="text/css">
    .margin-top-50 {
        margin-top: 50px;
    }
</style>

@Html.Hidden("CurrentPlanId", CurrentPlanId)

<div id="listingsuccessMessage" class="alert alert-success message-position" style="display: none;">
    <a class="close">×</a>
    <strong>Success.</strong> <span id="listingspanMessageSuccess"></span>
</div>
<div id="errorMessageDuplicatePlan" class="alert hide alert-error message-position-small">
    <a class="close">×</a>
    <div id="cErrorDuplicatePlan"></div>
</div>
<div class=" budgetColums budgetReporting remove_btm_pdng ">
    <div class="plannedCost budget_allocation ">
        <h3 class="source-sans-proregular" id="planCostTitle" style="padding-top: 0px;"></h3>
        <div class="progressPlanned" style="border-bottom-width: 0px; margin-bottom: 20px;">
            <div id="divPlanProgress" class="progress"></div>
        </div>
        <div class="progressText source-sans-proregular" id="planCostValue"></div>
        <div style="clear: both;"></div>
    </div>
    <div class="budgetCompare Section-width">
        <h3 class="source-sans-proregular" id="monthCompareTitle"></h3>
        <div class="budgetCompareInner innerSection-height" id="monthContainer">
        </div>
        <div style="clear: both;"></div>
    </div>
</div>
<div class="filter-base source-sans-prosemibold">
    <div id="divViewBy" style="display: none; border-left: none; margin-left: 0; padding-left: 0;">
        @Html.Label("View By:", new { id = "lblViewBy", style = "font-family:Helvetica Neue,Helvetica,Arial,sans-serif !important;font-size:13px;" })
        @Html.DropDownList("ddlViewBy", new SelectList((System.Collections.IEnumerable)ViewBag.ViewBy, "Value", "Text", myView), new { @class = "ddlStyleReport hide" })
    </div>
 <div id="divCostBudget">
      <label for="Cost_By:" id="lblCostBudget" style="font-family:Helvetica Neue,Helvetica,Arial,sans-serif !important;font-size:13px; float:left; margin-right:10px; font-weight:bold; top:0px; padding-top:5px;">Cost vs Budget:</label>
		     <div class="request-icon-block" style="top:0px; cursor:pointer;"><a id="aonCost" class="request" style="padding: 6px 27px 4px;">ON</a></div>
            <div class="request-icon-block" style="top:0px; cursor:pointer;"><a id="aoffCost" class="new-btn-plan request-btn-active">OFF</a></div>
</div>
 
 
     
    
      
</div>
<div id="DivloadPlan">
    <ul class="nav nav-tabs">
        <li class="title-header source-sans-proregular bold font-size25px">
            <form id="nl-form2" class="nl-form-plan-title without-margin plantitle">
                <select id="dropdown-plan-title" data-default="0%" class="" maxlength="40">
                </select>
                <div class="nl-overlay"></div>

            </form>
        </li>
        <li id="aAllocated" class="pull-right" onclick="TabLoad('aAllocated');">
            <a href="#">Budget</a>
        </li>
        <li id="aPlanned" class="pull-right" onclick="TabLoad('aPlanned');">
            <a href="#">Planned</a>
        </li>
        <li id="aActuals" class="pull-right" onclick="TabLoad('aActuals');">
            <a href="#">Actuals</a>
        </li>
    </ul>
</div>
<div id="divTabData" style="margin-top: 20px; margin-bottom: 30px;"></div>

<script>
    var CurrentPlanId = '@CurrentPlanId';
    var Bid;
    var expand = $("#hdnBudgetingExpandId").val();
    var CurrentView = '@myView';
    var currentTab = 'aAllocated';
    if ('@type' == 'plan') {
        currentTab = 'aPlanned';
    }
    else if ('@type' == 'actuals') {
        currentTab = 'aActuals';
    }

    $("#aonCost").click(function () {
        $("#aoffCost").removeClass('request-btn-active');
        $("#aonCost").addClass('request-btn-active');
        $('.red-corner-budget').css('display', 'block');
    });
    $("#aoffCost").click(function () {
        $("#aonCost").removeClass('request-btn-active');
        $("#aoffCost").addClass('request-btn-active');
        $('.red-corner-budget').css('display', 'none');
    });
    function ShowChangeLog(CurrentPlanId) {
        $('.changes').html('');
        var url = '@Url.Content("~/Home/LoadChangeLog/")';
        $('.changes').load(url + '?objectId=' + CurrentPlanId, function (response, status, xhr) {
            if (response == '{"serviceUnavailable":"~/Login/ServiceUnavailable"}') {
                //// Call function to redirect on service unavailibility.
                //// Added By: Maninder Singh Wadhva on 11/24/2014.
                //// Ticket: 942 Exception handeling in Gameplan.
                window.location = '@Url.Content(Common.RedirectOnServiceUnavailibilityPage)';
            }
        });
    }
    function HideMessages() {
        $("#listingsuccessMessage").slideUp(1);
        $('#listingspanMessageSuccess').html('');
        $("#content_wraper").removeClass("span10 padding-top40").addClass("span10 all-height");
    }
    var hideAllMessages = false;
    $(document).ready(function () {
        $("#errorMessageDuplicatePlan").slideUp(300);
        $(".selectBox select").selectbox();
        $("#ddlViewBy").multiselect({
            multiple: false,
            CustomName: '@Common.CustomTitle',
            selectedList: 1,
            CustomCampaignName: "@Common.CampaignCustomTitle",
            CustomProgramName: "@Common.ProgramCustomTitle",
            CustomTacticName: "@Common.TacticCustomTitle",
            classes: 'custom-right-pos' // Added by Sohel Pathan on 11/11/2014 for PL ticket #934, NOTE : Please don't change class name, it is used in js.
        }).multiselectfilter({
            CustomCampaignName: "@Common.CampaignCustomTitle",
            CustomProgramName: "@Common.ProgramCustomTitle",
            CustomTacticName: "@Common.TacticCustomTitle"
        });
        $("#ddlViewBy").multiselect('refresh');
        LoadPlan();
        onClickPlanTitle();
    });
    function ExpandItems() {
        expand = $("#hdnBudgetingExpandId").val();
        try {
            if (CurrentView != "0") {

                $(".column1").find(".firstLevel").each(function () {

                    var currObj = $(this).attr('id');

                    $('#' + currObj).css('display', 'block');
                    $(".sub[data-parent='" + currObj + "']").css('display', 'block');
                    $('#' + currObj + ' a:first-child').addClass('collapse');
                });
            }

            var strExpand = expand;
            var strExpandType = '';
            var strExpandId = 0;
            if (strExpand != '') {
                if (strExpand.indexOf('lineitem') >= 0) {
                    strExpandType = 'lineitem';
                }
                else if (strExpand.indexOf('tactic') >= 0) {
                    strExpandType = 'tactic';
                }
                else if (strExpand.indexOf('program') >= 0) {
                    strExpandType = 'program';
                }
                else if (strExpand.indexOf('campaign') >= 0) {
                    strExpandType = 'campaign';
                }

                strExpandId = strExpand.replace(strExpandType, '');
                //  if ($.isNumeric(strExpandId)) {removed by mitesh vaishnav for make expand functionality working in planned and actual tab
                    var currObj, tacticDP, programDP, campaignDP;
                    if (strExpandType == 'lineitem') {
                        if ($("#hdnBudgetingIsDelete").val() != "true") {
                            currObj = $('#' + strExpandId.replace('_','')).parent();
                            tacticDP = $(currObj).parent().attr('data-parent'); //tactic
                            programDP = $(currObj).parent().parent().attr('data-parent'); //program
                            campaignDP = $(currObj).parent().parent().parent().attr('data-parent'); //campaign
                        }
                        else {
                            if (currentTab != 'aAllocated') {
                                strExpandId = "#tacticcpt_" + strExpandId;
                            }

                            currObj = $(strExpandId).next();
                            tacticDP = $(currObj).attr('data-parent'); //tactic
                            programDP = $(currObj).parent().attr('data-parent'); //program
                            campaignDP = $(currObj).parent().parent().attr('data-parent'); //campaign
                            $("#hdnBudgetingIsDelete").val("false");
                        }

                        $('#' + campaignDP).css('display', 'block');
                        $(".sub[data-parent='" + campaignDP + "']").css('display', 'block');
                        $('#' + campaignDP + ' a:first-child').addClass('collapse');
                        $('#' + programDP).css('display', 'block');
                        $(".sub[data-parent='" + programDP + "']").css('display', 'block');
                        $('#' + programDP + ' a:first-child').addClass('collapse');
                        $('#' + tacticDP).css('display', 'block');
                        $(".sub[data-parent='" + tacticDP + "']").css('display', 'block');
                        $('#' + tacticDP + ' a:first-child').addClass('collapse');

                        if ('@myView' != "0") {
                            var mainDP = $(currObj).parent().parent().parent().parent().attr('data-parent'); //audiance
                            $('#' + mainDP).css('display', 'block');
                            $(".sub[data-parent='" + mainDP + "']").css('display', 'block');
                            $('#' + mainDP + ' a:first-child').addClass('collapse');
                        }

                    }
                    else if (strExpandType == 'campaign') {
                        if (currentTab != 'aAllocated') {
                            strExpand = 'campaignc_' + strExpandId;
                        }
                        $(".sub[data-parent='" + strExpand + "']").css('display', 'block');
                        $('#' + strExpand).css('display', 'block');
                        $('#' + strExpand + ' a:first-child').addClass('collapse');
                    }
                    else if (strExpandType == 'program') {
                        if (currentTab != 'aAllocated') {
                            strExpand = 'programcp_' + strExpandId;
                        }
                        if (typeof $('#' + strExpand).parent().attr('data-parent') != 'undefined') {
                            $('#' + strExpand).parent().css('display', 'block');

                            campaignDP = $('#' + strExpand).parent().attr('data-parent');
                            $(".sub[data-parent='" + campaignDP + "']").css('display', 'block');
                            $('#' + campaignDP).css('display', 'block');
                            $('#' + campaignDP + ' a:first-child').addClass('collapse');
                        }
                        $(".sub[data-parent='" + strExpand + "']").css('display', 'block');
                        $('#' + strExpand).css('display', 'block');
                        $('#' + strExpand + ' a:first-child').addClass('collapse');
                       
                    }
                    else if (strExpandType == 'tactic') {
                        if (currentTab != 'aAllocated') {
                            strExpand = 'tacticcpt_' + strExpandId;
                        }
                        var prgm = $('#' + strExpand).parent().attr('data-parent');
                        var cmgn = $('#' + prgm).parent().attr('data-parent');
                        if (typeof cmgn != 'undefined') {
                            $(".sub[data-parent='" + cmgn + "']").css('display', 'block');
                            $('#' + cmgn).css('display', 'block');
                            $('#' + cmgn + ' a:first-child').addClass('collapse');
                        }
                        if (typeof prgm != 'undefined') {
                            $('#' + strExpand).parent().css('display', 'block');
                            $(".sub[data-parent='" + prgm + "']").css('display', 'block');
                            $('#' + prgm).css('display', 'block');
                            $('#' + prgm + ' a:first-child').addClass('collapse');
                        }
                        $(".sub[data-parent='" + strExpand + "']").css('display', 'block');
                        $('#' + strExpand).css('display', 'block');
                        $('#' + strExpand + ' a:first-child').addClass('collapse');

                    }
       // } removed by mitesh vaishnav for make expand functionality working in planned and actual tab
    }
} catch (e) {

}
        //Added By : Kalpesh Sharma : #739 Adding additional views to Budget Planning screen
    var data = $(".column1").get(0);
    $(".budget-table .column1 > tr").each(function () {
        $(this).width(data.scrollWidth);
    });
}
    $("#ddlViewBy").change(function () {
    CurrentView = $('#ddlViewBy').val();
    var TacCustomTitle = "@Common.TacticCustomTitle";
        //alert("TacCustomTitle: " + TacCustomTitle + " index: " + CurrentView.indexOf(TacCustomTitle));
        if (CurrentView.length > 0 && CurrentView.indexOf(TacCustomTitle) >= 0) {

            CurrentView = CurrentView.replace(TacCustomTitle, "");
            $('#divCostBudget').hide();
        }
        else {
            if (currentTab == "aPlanned") {
                $('#divCostBudget').show();
            }
        }
            TabLoad(currentTab);
        });

    function TabLoad(sender) {
            currentTab = sender;
            $("#hdnBudgetingCurrentTab").val(currentTab);
            $("#hdnBudgetingCurrentPlanId").val(CurrentPlanId);

            $('.pull-right').removeClass('active');
            $('#' + sender).addClass('active');
            if (CurrentPlanId != 0) {
                $('.plannedCost').children().show();
                $('.budgetCompare').children().show();
                $('#nl-form2').show();

                if (currentTab == 'aAllocated') {
                    $('#divTabData').load('@Url.Action("GetAllocatedBugetData", "Plan")' + '?PlanId=' + CurrentPlanId, function (response, status, xhr) {
                if (response == '{"serviceUnavailable":"~/Login/ServiceUnavailable"}') {
                    //// Call function to redirect on service unavailibility.
                    //// Added By: Maninder Singh Wadhva on 11/24/2014.
                    //// Ticket: 942 Exception handeling in Gameplan.
                    window.location = '@Url.Content(Common.RedirectOnServiceUnavailibilityPage)';
                }
                ExpandItems();
            });
            $("#DivloadPlan").removeClass('margin-top-50');
        }
        else if (currentTab == 'aPlanned') {
            $('#divViewBy').show();
            $('#divTabData').load('@Url.Action("GetBudgetedData", "Plan")' + '?PlanId=' + CurrentPlanId + '&budgetTab=1&viewBy=' + CurrentView, function (response, status, xhr) {
                    if (response == '{"serviceUnavailable":"~/Login/ServiceUnavailable"}') {
                        //// Call function to redirect on service unavailibility.
                        //// Added By: Maninder Singh Wadhva on 11/24/2014.
                        //// Ticket: 942 Exception handeling in Gameplan.
                        window.location = '@Url.Content(Common.RedirectOnServiceUnavailibilityPage)';
                }
                ExpandItems();
            });
            $("#DivloadPlan").addClass('margin-top-50');
        }
        else if (sender == 'aActuals') {
            $('#divViewBy').show();
            $('#divTabData').load('@Url.Action("GetBudgetedData", "Plan")' + '?PlanId=' + CurrentPlanId + '&budgetTab=2&viewBy=' + CurrentView, function (response, status, xhr) {
                if (response == '{"serviceUnavailable":"~/Login/ServiceUnavailable"}') {
                    //// Call function to redirect on service unavailibility.
                    //// Added By: Maninder Singh Wadhva on 11/24/2014.
                    //// Ticket: 942 Exception handeling in Gameplan.
                    window.location = '@Url.Content(Common.RedirectOnServiceUnavailibilityPage)';
                }
                ExpandItems();
            });
            $("#DivloadPlan").addClass('margin-top-50');
        }
               
}
else {
    $('#nl-form2').hide();
    $('#divTabData').html('');
    $('#DivloadPlan').html('<h5 style="padding-left:22px;">No plan exist</h5>');
    $('.plannedCost').children().hide();
    $('.budgetCompare').children().hide();
    $('#divViewBy').hide();
}
    if (hideAllMessages) {
        $('.datepicker.dropdown-menu').css("display", "none");
        $("#slidepanel").css("display", "none");
        $("#slidepanel-container").empty();
        $("#errorMessageDuplicatePlan").slideUp(300);
        HideMessages();
    }
}


function LoadPlan() {
    //  $('#DivloadPlan').load('@Url.Action("BudgetPlanList", "Plan")', function () { TabLoad(currentTab); ShowChangeLog(CurrentPlanId); hideAllMessages = true; });
    ShowChangeLog(CurrentPlanId);
    var plans = @Html.Raw(Json.Encode(ListBudgetingPlan.plans))
   populateNF(plans, "dropdown-plan-title");
    var nlform = new NLForm(document.getElementById('nl-form2'));
    TabLoad(currentTab);   
    hideAllMessages = true;
}

function populateNF(items, id) {
    var $dropdown = $("#" + id);
    var $html = '';
    if (items.length > 0) {
        $.each(items, function (index, plan) {
            if (plan.Selected) {
                $html += '<option value="' + plan.Value + '" selected>' + plan.Text + '</option>';
                CurrentPlanId = plan.Value;
            } else {
                $html += '<option value="' + plan.Value + '">' + plan.Text + '</option>';
            }
        });
    } else {
        $html += '<option value=' + 0 + ' selected>' + "Plan Title" + '</option>';
        CurrentPlanId = 0;
    }
    $dropdown.append($html);
}
function onClickPlanTitle() {
    $('#nl-form2 > div[class="nl-field nl-dd"]').find('li').click(function (e) {
        CurrentPlanId = $(this).attr('value');
        ShowChangeLog(CurrentPlanId);
        $("#CurrentPlanId").val(CurrentPlanId);
        TabLoad(currentTab);
        $('.datepicker.dropdown-menu').css("display", "none");
        $("#slidepanel").css("display", "none");
        $("#slidepanel-container").empty();
        $("#errorMessageDuplicatePlan").slideUp(300);
        HideMessages();
    });
}

$(document).on("click", "#LeftNavInput", function (e) {
    //Added By : Kalpesh Sharma : #741: Maintain context while switching with in plan's tabs
    var queryStringArr = [];

    queryStringArr.push(
     {
         key: 'id',
         Value: CurrentPlanId
     });

    displayconfirm('@Url.Content("~/Plan/Create")', queryStringArr);
});

$(document).on("click", "#LeftNavAddActivity", function (e) {
    var queryStringArr = [];

    queryStringArr.push(
     {
         key: 'ActiveMenu',
         Value: "Plan"
     });

    queryStringArr.push(
     {
         key: 'currentPlanId',
         Value: CurrentPlanId
     });

    displayconfirm('@Url.Content("~/Home/Index")', queryStringArr);
});

$(document).on("click", "#LeftNavCampaigns", function (e) {
    var queryStringArr = [];
    displayconfirm('@Url.Action("Assortment", "Plan")', queryStringArr);
});

$(document).on("click", "#aApplyToCalender", function (e) {
    window.location.href = '@Url.Action("ApplyToCalendar", "Plan")';
    });

    function displayconfirm(strURL, queryStringArr) {
        HideMessages();
        // window.location.href = strURL;
        formSubmitEvent(strURL, queryStringArr);
    }

    $(document).on("click", "#confirmClose", function (e) {
        $("#errorMessageDuplicatePlan").slideUp(400);   // Modified by Sohel Pathan on 18/08/2014 for Internal Review Points
    });

    function isDataChanged() {
        var changed = false;

        $('#slidepanel-container').find("input[type=text],textarea,select, .priceValue").each(function () {     // Modified by Sohel Pathan on 18/08/2014 for Internal Review Points
            if ($(this).is('[readonly]') == false) {
                var iv = $(this).attr("myValue");
                if ($(this).attr('id') == 't_startdate' || $(this).attr('id') == 't_enddate') {
                    var strValue = $(this).val();
                    if (strValue != null && strValue != '') {
                        strValue = strValue.replace(' 12:00:00 AM', '');
                        $(this).val(strValue);
                        var newDateObj = new Date($(this).val());
                        var oldDateObj = new Date(iv);
                        if (newDateObj.getFullYear() + '-' + newDateObj.getMonth() + '-' + newDateObj.getDate() != oldDateObj.getFullYear() + '-' + oldDateObj.getMonth() + '-' + oldDateObj.getDate()) {
                            changed = true;
                            return false;   // Added by Sohel Pathan on 19/08/2014 for Internal Review Points
                        }
                    }
                }
                else {
                    if ($(this).val() != iv) {
                        changed = true;
                        return false;   // Added by Sohel Pathan on 18/08/2014 for Internal Review Points
                    }
                }
            }
        });
        return changed;
    }
    // Start - Added by Sohel Pathan on 19/08/2014 for Internal Review Points


    $("#header a").not("#ContactSupport").click(function () {
        if (isDataChanged()) {
            displayconfirm($(this).attr('href'));
            return false;
        }
        else {
            return true;
        }
    });

    // End - Added by Sohel Pathan on 19/08/2014 for Internal Review Points
</script>