@using RevenuePlanner.Helpers
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>@ViewBag.Title</title>
    <link rel="shortcut icon" href="@Url.Content("~/Content/images/favicon.png")">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    @RenderSection("nlFormContent", false)

    @Styles.Render("~/Content/css/GetCSS")
    <link rel="stylesheet" href="@Url.Content("~/Content/css/bootstrap-responsive.css")" type="text/css" />
    <link rel="stylesheet" href="@Url.Content("~/Content/css/style.css?n=")@DateTime.Now" type="text/css" />
    <link rel="stylesheet" href="@Url.Content("~/Content/css/style_extended.css?n=")@DateTime.Now" type="text/css" />

    @Scripts.Render("~/bundles/GetJS")
    <script type="text/javascript" src="@Url.Content("~/Scripts/js/scripts.js?n=")@DateTime.Now"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/js/scripts_extended.js?n=")@DateTime.Now"></script>

</head>
<body>
    <div class="container-fluid all-height">
        @{
            string a = Convert.ToString(ViewBag.ActiveMenu);
            if (a == null)
            {
                a = "a";
            }
            else
            {
                a = a.ToLower();
            }
        }
        @Html.Hidden("ActiveMenu", a)
        <div class="row-fluid">
            @Html.Partial("_header")
        </div>
        <div class="row-fluid calc-height">
            <div id="sidebar" class="span2">
                @RenderSection("Sidebar", false)
            </div>
            <div id="content_wraper" class="span10 all-height">
                @RenderBody()
            </div>
            <div class="clear"></div>
        </div>
        <div style="clear: both; margin-bottom: 50px;"></div>
    </div>
    <footer><span class="source-sans-proregular">Copyright &copy; @System.DateTime.Now.Year.ToString() Hive9, Inc. All rights reserved.<a href="//www.hive9.com/ssa-sla" target="_blank">Terms of Use</a></span></footer>
    <div id="slidepanel" class="sidebar-form source-sans-proregular scrolled_div_form panel_right loading" style="display: none">
        <div id="slidepanel-container">
        </div>
    </div>
    <!--End sidebar-->
    <div id="div_contactSupport"></div>
    <span class="functioncallselector"></span>
</body>
</html>
@RenderSection("Scripts", false)

<script type="text/javascript">
    var sess_pollInterval = 60000;
    var sess_expirationMinutes = parseInt('@Session.Timeout');
    var sess_warningMinutes = sess_expirationMinutes - 5;;
    var sess_intervalID;
    var sess_lastActivity;
    var warningRunTime = 0;

    function initSession() {
        sess_lastActivity = new Date();
        sessSetInterval();
        $(document).bind('keypress.session', function (ed, e) {
            sessKeyPressed(ed, e);
        });
    }
    function sessSetInterval() {
        sess_intervalID = setInterval('sessInterval()', sess_pollInterval);
    }
    function sessClearInterval() {
        clearInterval(sess_intervalID);

    }
    function sessKeyPressed(ed, e) {
        sess_lastActivity = new Date();
    }

    function sessInterval() {
        var now = new Date();
        //get milliseconds of differneces
        var diff = now - sess_lastActivity;
        //get minutes between differences
        var diffMins = (diff / 1000 / 60);
        if (diffMins >= sess_warningMinutes+warningRunTime) {
            sessClearInterval();
            $('#div_contactSupport').empty();
            var url = '@Url.Content("~/Common/LoadSessionWarning/")';
            $("#div_contactSupport").load(url);
            warningRunTime = 5;
        }
    }

</script>
<script type="text/javascript">
    $.ajaxSetup({
        cache: false
    });
    var isAlerted = false;
    $(document).ready(function () {
        initSession();
        var IsOffline = '@RevenuePlanner.Helpers.Common.IsOffline';

        //// Start - Added by :- Pratik Chauhan on 22/09/2014 for PL ticket #468 to display maintenance page
        if (IsOffline.toLowerCase() == 'false') {
            $(window).attr('name', '@RevenuePlanner.Helpers.Sessions.User.UserId');
        }
        //// End - Added by :- Pratik Chauhan on 22/09/2014 for PL ticket #468 to display maintenance page

        $('#ContactSupport').click(function () {
            $("#div_contactSupport").empty();
            var url = '@Url.Content("~/Common/LoadSupportPartial/")';   //// Modified by Sohel Pathan on 23/05/2014 for internal review points.
            $("#div_contactSupport").load(url);
        });
        CheckDataInconsistency();
        switch ($('#ActiveMenu').val().toString().toLowerCase()) {
            case 'home':
                $('.home').addClass('active');
                break;
            case 'model':
                $('.model').addClass('active');
                break;
            case 'plan':
                $('.plan').addClass('active');
                break;
            case 'boost':
                $('.boost').addClass('active');
                break;
            case 'report':
                $('.report').addClass('active');
                break;
            case 'pref':
                $('.pref').addClass('active');
                break;
            default:
                $('.home').addClass('active');
                break;
        }


    });
    function CheckDataInconsistency() {
        if ('@Sessions.IsDisplayDataInconsistencyMsg' == 'True') {
            var IsSessionClient = readCookie('DataClientId' + '@Sessions.User.ClientId.ToString().ToLower()');
            if (IsSessionClient != null) {
                alert('@Common.objCached.DataInconsistency');
                var retvalue = '@RevenuePlanner.Helpers.Common.SetSessionVariable()';
            }
        }
    }


    $(".alert").find(".close").on("click", function (e) {
        e.stopPropagation();
        e.preventDefault();
        $(this).closest(".alert").slideUp(300);/*SlideUp value change 400 to 300 by Mitesh Vaishnav on 04 july 2014*/
    });
    $.ajaxSetup({
        beforeSend: function (x) { //Called before every request
            initSession();
            myApp.showPleaseWait();
        },
        statusCode: {
            403: function () {
                myApp.hidePleaseWait();
                //this will catch any and all access denied errors
                if (isAlerted == false) {
                    isAlerted = true;
                    alert("@Common.objCached.SessionExpired");
                    window.location = "@Url.Content("~/login/Index")";
                }
            }
        },
        error: function (x, e) { // Called when error occured
            GoToLogin();
        }
    });

    function GoToLogin() {
        myApp.hidePleaseWait();
        //In case of error and it is due to session timed out -  the above code was not working in case of div.load, used to display slidepanel
        var IsSessionExist = readCookie('IsSessionExist');
        if (IsSessionExist == 0 && isAlerted == false) {
            isAlerted = true;
            alert("@Common.objCached.SessionExpired");
            if (readCookie('ReturnURL') != "") {
                window.location = '@Url.Content("~/login/Index?ReturnUrl=")' + readCookie('ReturnURL');
            }
            else {
                window.location = "@Url.Content("~/login/Index")";
            }
        }
    }
    function readCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for (var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') c = c.substring(1, c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
        }
        return null;
    }
    $(document).ajaxStop(function () { //Called after every ajax request completed
        myApp.hidePleaseWait();
    });
    var reason = 'user';
    function CheckUserSession(Sender, isSender) {
        $.ajax({
            type: 'GET',
            url: '@Url.Content("~/Home/CheckUserId/")?UserId=' + $(window).attr('name'),
            success: function (data) {
                reason = 'callback';
                if (data.returnURL == '#') {
                    if (isSender) {
                        $(Sender).click();
                    }
                    else {

                    }
                }
                else {
                    window.location = data.returnURL;
                }
            }
        });
    }

    var myApp;
    myApp = myApp || (function () {
        var pleaseWaitDiv = $('<div style="z-index:99999" class="modal hide" id="pleaseWaitDialog" data-backdrop="static" data-keyboard="false"><div class="modal-header">Please wait...</div><div class="modal-body"><div class="progress progress-striped active"><div class="bar" style="width: 100%;"></div></div></div></div>');
        return {
            showPleaseWait: function () {
                pleaseWaitDiv.modal();
            },
            hidePleaseWait: function () {
                pleaseWaitDiv.modal('hide');
            },

        };
    })();
</script>
