@model RevenuePlanner.Models.Plan_Campaign_Program_Tactic_LineItemModel
@using RevenuePlanner.Helpers
@{

    string campaignTitle = Convert.ToString(ViewBag.CampaignTitle);
    string programTitle = Convert.ToString(ViewBag.ProgramTitle);
    string tacticTitle = Convert.ToString(ViewBag.TacticTitle);
    string owner = Convert.ToString(ViewBag.Owner);
    bool isOtherLineitem = false;
    if (Model != null)
    {
        isOtherLineitem = Model.IsOtherLineItem;
    }

    //// Flag to indicate unavailability of web service.
    //// Added By: Maninder Singh Wadhva on 11/24/2014.
    //// Ticket: 942 Exception handeling in Gameplan.
    bool isServiceUnavailable = Convert.ToBoolean(ViewBag.IsServiceUnavailable);
}
<link href="@Url.Content("~/Content/css/DHTMLX/dhtmlxtreegrid1_min.css")" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="@Url.Content("~/Scripts/js/DHTMLX/dhtmlxTreeGrid.js")">
</script>
<script src="~/Scripts/js/bootstrap-datepicker.js"></script>
<style type="text/css">
    #btnCancel {
        color: gray;
        margin-top: 6px;
    }
    #divPartial .simpleSelectBox .sbHolder {
            background: url(@Url.Content("~/Content/images/button-arrow.png")) no-repeat scroll right 8px center #dff0f8 !important;
            box-shadow: 1px -8px 13px #dff0f8 inset, 0 1px 2px #ededed;
            margin-bottom: 0;
            z-index: auto;
    }
    #divPartial .ui-multiselect {
         background: none repeat scroll 0 0 #dff0f8 !important;
     }
    #divPartial .sbToggle {
        border-top: 4px solid #6d6d6d !important;
    }
    #divPartial .sbHolder {
        background-color: #dff0f8 !important;
        background-image:none;
    }
     #multipleselect_LineItemTypeId {
        left: 0 !important;
        top: 20px !important;
        min-width:205px;
    }
    .objbox
    {
    overflow:hidden !important;
    }
</style>
@using (Html.BeginForm())
{

    @Html.HiddenFor(model => model.PlanLineItemId, new { id = "PlanLineItemId" })
    @Html.HiddenFor(model => model.PlanTacticId, new { id = "PlanTacticId" })
    @Html.HiddenFor(model => model.IsOtherLineItem, new { id = "hdnIsOtherLineItem" })
    @Html.HiddenFor(model => model.Description, new { id = "hdnDescription" })
    <div class="inspect-column-parent source-sans-proregular remove-bottom-border inspect-column-parent-reformatting inspect_attribute_parent" style="margin-bottom:0px;">

        <div class="span6" id="inspect-modal-left-column1">
            <p>@Html.Raw("Parent Campaign")</p>
            @Html.TextBox("txtCamapignTitle", HttpUtility.HtmlDecode(campaignTitle), new { @class = "input-small truncate", style = "background:#F2F2F2;", @readonly = "true", title = campaignTitle })
            <p>@Html.Raw("Parent Program")</p>
            @Html.TextBox("txtProgramTitle", HttpUtility.HtmlDecode(programTitle), new { @class = "input-small truncate", style = "background:#F2F2F2;", @readonly = "true", title = programTitle })

            <p>@Html.Raw("Description")</p>
            @Html.TextArea("Description", Model.Description, new { id = "txtDescription", @class = "span12 text-area-size input-setup", style = "height:92px;" })     @*Modified by Viral Kadiya on 11/15/2014 to resolve issue for PL ticket #794*@
            <div style="clear: both; width: 250%;">
                <label style="color: #808080" id="last-synced" class="pull-left">@ViewBag.LastSync</label>
            </div>
        </div>
        <div class="span3 no_margin_top" id="inspect-modal-left-column2" style="margin-left: 10px;">
            <p>@Html.Raw("Parent Tactic")</p>
            @Html.TextBox("txtTacticTitle", HttpUtility.HtmlDecode(tacticTitle), new { @class = "input-small truncate", style = "background:#F2F2F2;", @readonly = "true", title = tacticTitle })
            @if (!isOtherLineitem)
            {
                <p id="lblType">Type <span class="required-asterisk">*</span></p>
                <span style="min-width: 100%; position: relative;display:block;">
                    @Html.DropDownListFor(model => model.LineItemTypeId, new SelectList((System.Collections.IEnumerable)ViewBag.lineItemTypes, "LineItemTypeId", "Title"), "Please Select", new { @class = "ddlStyle resubmission hide", require = "true", label = "Type" })
                </span>
            }


        </div>
        <div class="span3 review_no_padding" id="inspect-modal-left-column3">
            <p>@Html.Raw("Owner")</p>
            @Html.TextBox("txtOwner", owner, new { @class = "span12 input-small truncate", style = "background:#F2F2F2;", @readonly = "true" })
            <p>@Html.Raw("Line Item Cost")</p>
            @Html.TextBoxFor(model => model.Cost, new { @class = "span12 input-small currency_dollar truncate input-setup", id = "txtLineItemCost" })

        </div>
    </div>

    <ul id="FinanceMappingHeading" class="nav nav-tabs new-margin padding-bottom10 clear border-bottom-div">
        <li class="pull-left">
            <h3 class="modal-popup-innertitle source-sans-proregular">Finance Mapping</h3>
        </li>
    </ul>

    <div id="CustomHtmlHelperfieldforMapping" class="inspect-column-parent source-sans-proregular remove-bottom-border margin-bottom0 inspect_attribute_parent">
        @HtmlHelpers.GenerateMappingFieldsForInspectPopup(Model.PlanLineItemId, Enums.InspectPopupMode.Edit.ToString())
    </div>
    @*<div style="width: 100%; clear: both" class="wraper-btns cf border-top-div ">
            <div class="span2 btn-save" style="width: 80px;">
                <button id="save_LineItem" class="btn btn-blue text-shadow-blue source-sans-proregular margin-top23 popup_button_save" type="button">Save </button>
            </div>
            <div class="span2">
                <button id="btnCancel" class="close-form btn-link source-sans-proregular popup_button_cancel" style="float: left; margin-top: 30px !important" type="button">Cancel</button>
            </div>
        </div>*@

}
<script type="text/javascript">
    var TreeViewDdl;
    var ListOfItmeCheck= {
        Ids: [],
        values:[]
    };

    var Weights= {
        ChkId: [],
        txtId: [],
        values:[]
    };
    var totalWeightage = 0;

    //// Function to redirect to login page on unavailability of web service.
    //// Added By: Maninder Singh Wadhva on 11/24/2014.
    //// Ticket: 942 Exception handeling in Gameplan.
    function redirectOnServiceUnavailibility() {
        if ('@Html.Raw(Json.Encode(isServiceUnavailable))' == 'true') {
            window.location = '@Url.Content(Common.RedirectOnServiceUnavailibilityPage)';
        }
    }

    //Added BY Komal Rawal for #1617
    $('.dropdown_new_btn').click(function () {
        if($(this).next().css("display") == "none")
        {
            $(this).next().css("width","auto");
            $(this).next().css("display","block");
            LoadBudgetDropdown();
        }
        else
        {
            $(this).next().css("width","0px");
            $(this).next().css("display","none");
        }
    });

    function LoadBudgetDropdown()
    {
        var GridData;
        TreeViewDdl = new dhtmlXGridObject('treeviewddl');
        $.ajax({
            dataType: 'json',
            url: '@Url.Content("~/Inspect/LoadBudgetDropdown/")',
            data: {
                PlanLineItemID : @Model.PlanLineItemId,
            },
            async:false,
            success: function (data) {
                GridData=data.data;
                var imgpath = '@Url.Content("~/codebase/imgs/")';
                TreeViewDdl.setImagePath(imgpath);
                TreeViewDdl.setHeader("--Select a Budget--");
                TreeViewDdl.enableAutoHeight(true);
                TreeViewDdl.enableAutoWidth(true);
                TreeViewDdl.enableTreeCellEdit(false)
                TreeViewDdl.setImageSize(1, 1);
                TreeViewDdl.setColTypes("tree");
                TreeViewDdl.init();

                TreeViewDdl.insertColumn(2, 'Weightage', 'ro');
                //TreeViewDdl.setSkin("");
                TreeViewDdl.parse(GridData, "json");
                TreeViewDdl.attachEvent("onOpenEnd", function () {
                    for(var i=0;i<ListOfItmeCheck.Ids.length;i++)
                    {
                        $('#'+Weights.txtId[i]).val(Weights.values[i]);
                        var optionId = ListOfItmeCheck.Ids[i];
                        if (totalWeightage != 100) {
                            $('#'+ 'wt_'+ ListOfItmeCheck.Ids[i]).addClass('error');
                        }
                        else {
                            if ($('#'+ 'wt_'+ ListOfItmeCheck.Ids[i]).hasClass('error')) {
                                $('#'+ 'wt_'+ ListOfItmeCheck.Ids[i]).removeClass('error')
                            }
                        }
                    }

                });

            }
        });

        TreeViewDdl.expandAll();
         ListOfItmeCheck= {
            Ids: [],
            values:[]
        };
         Weights= {
            ChkId: [],
            txtId: [],
            values:[]
        };
        totalWeightage = 0;
        $('#treeviewddl').find('input:checkbox:checked').each(function () {
            ListOfItmeCheck.Ids.push($(this).attr('id'));
            ListOfItmeCheck.values.push($(this).attr('title'));
            totalWeightage += parseInt($('#'+ 'wt_'+ $(this).attr('id')).val());
            Weights.values.push($('#'+ 'wt_'+ $(this).attr('id')).val());
            Weights.ChkId.push($(this).attr('id'));
            Weights.txtId.push('wt_'+ $(this).attr('id'));
        });
        if(totalWeightage != 100)
        {
            DivideEqualInputValue();
        }
        TreeViewDdl.collapseAll();



    }


    function ddlcheckboxclick(items)
    {
        $('.span3').find('.dropdown_new_btn p:first').text("");
        if(items.checked)
        {
            ListOfItmeCheck.Ids.push(items.id);
            ListOfItmeCheck.values.push(items.title);
            DivideEqualInputValue();
        }
        else{
            var index = ListOfItmeCheck.Ids.indexOf(items.id);
            if (index >= 0) {
                ListOfItmeCheck.Ids.splice( index, 1 );
                ListOfItmeCheck.values.splice( index, 1 );
                $('#'+ 'wt_'+ items.id).val("");
                if ($('#'+ 'wt_'+ items.id).hasClass('error')) {
                    $('#'+ 'wt_'+ items.id).removeClass('error')
                }
                DivideEqualInputValue();
            }
        }
        var Selectedvalue = "";
        for(var i=0;i<ListOfItmeCheck.Ids.length;i++)
        {
            Selectedvalue += ListOfItmeCheck.values[i]+', ';
        }

        if (Selectedvalue.indexOf(',') > 0) {
            Selectedvalue = Selectedvalue.slice(0, -2);
            $('.span3').find('.dropdown_new_btn p:first').text(Selectedvalue);
            $('.span3').find('.dropdown_new_btn p:first').attr('title', Selectedvalue);
        }
        else {
            $('.span3').find('.dropdown_new_btn p:first').text('Please Select');
        }

    }

    $('#treeviewddl').find('input[type=text]').live("keyup", function(event) {
        totalWeightage=0;
        var inputText = $(this);
        var Code = inputText.attr('id').toString().split('_')[1].toString();
        var isAllColumnInputBlank = true;

        for(var i=0;i<ListOfItmeCheck.Ids.length;i++)
        {
            var optionId = ListOfItmeCheck.Ids[i];
            isAllColumnInputBlank = false;
            var index=Weights.ChkId.indexOf(Code);
            if(index>=0)
            {
                Weights.values[index]= parseFloat(inputText.val());
            }

            totalWeightage += parseFloat(Weights.values[i]);
        }

        for(var i=0;i<ListOfItmeCheck.Ids.length;i++)
        {
            var optionId = ListOfItmeCheck.Ids[i];
            if (totalWeightage != 100 && !isAllColumnInputBlank) {
                $('#'+ 'wt_'+ ListOfItmeCheck.Ids[i]).addClass('error');
            }
            else {
                if ($('#'+ 'wt_'+ ListOfItmeCheck.Ids[i]).hasClass('error')) {
                    $('#'+ 'wt_'+ ListOfItmeCheck.Ids[i]).removeClass('error')
                }
            }
        }

    });


    function DivideEqualInputValue() {
        Weights= {
            ChkId: [],
            txtId: [],
            values:[]
        };
        totalWeightage=0;
        var checkedCheckbox = ListOfItmeCheck.Ids.length;
        var inputValues = parseInt(100 / checkedCheckbox);
        var residual = parseInt(100 % checkedCheckbox);
        var checkedResidualDiff = checkedCheckbox - residual;
        var res_counter = 0;
        for(var i=0;i<ListOfItmeCheck.Ids.length;i++)
        {
            res_counter += 1;
            var index = ListOfItmeCheck.Ids.indexOf(ListOfItmeCheck.Ids[i]);
            if (index >= 0) {
                Weights.ChkId.push(ListOfItmeCheck.Ids[i]);
                Weights.txtId.push('wt_'+ ListOfItmeCheck.Ids[i]);
                if (res_counter <= checkedResidualDiff) {
                    Weights.values[i]=(inputValues.toString());
                    $("#"+Weights.txtId[i]).val((inputValues.toString()));
                    $("#"+Weights.txtId[i]).removeClass('error');
                }else{
                    Weights.values[i]=((inputValues + 1).toString());
                    $("#"+Weights.txtId[i]).val(((inputValues + 1).toString()));
                    $("#"+Weights.txtId[i]).removeClass('error');
                }
            }
            else{
                Weights.ChkId.splice( index, 1 );
                Weights.txtId.splice( index, 1 );
                Weights.values.splice( index, 1 );
            }
            totalWeightage += parseFloat(Weights.values[i]);
        };

    }
    //End

    $(document).ready(function () {

        $(document).click(function(){
            $("#treeviewddl").css("display","none");
        });
        $('.dropdown_new_btn').on('click', function (e) {
            e.stopPropagation();
        });
        //// Call function to redirect on service unavailibility.
        //// Added By: Maninder Singh Wadhva on 11/24/2014.
        //// Ticket: 942 Exception handeling in Gameplan.
        redirectOnServiceUnavailibility();

        $("#successMessageViewLineItem").slideUp(50);
        $("#errorMessageEditLineitem").slideUp(50);
        $('.currency_dollar').priceFormat({ prefix: '$', centsSeparator: '', thousandsSeparator: ',', centsLimit: 0 });
        //$(".simpleSelectBox select").selectbox();
        $('#LineItemTypeId').multiselect({
            multiple: false,
            noneSelectedText: "Please Select",
            selectedList: 1,
            CustomName: '@Common.CustomTitle'
        }).multiselectfilter();



        $('#LineItemTypeId').next().css('width', '95%');
        $('#LineItemTypeId').next().css('min-height', '30px');

        var spanLineItemType = $('#multipleselect_LineItemTypeId');
        $('#btnMultiselect_LineItemTypeId').after(spanLineItemType);

        if ('@isOtherLineitem.ToString().ToLower()' == 'true') {
            $("#lblType").css("display", "none");
            $("#ddlTypeArea").css("display", "none");
            $('#txtLineItemCost').attr('readonly', true);
            $("#lblLineitemTitle").css('display', 'block');
            $("#txtTitle").css('display', 'none');
        }
        //Start - Added by Viral Kadiya on 17/11/2014 to resolve PL ticket #947.
        $('.input-setup').addClass('light-blue-background');
        $('.ddlStyle .ui-multiselect.ui-widget.ui-state-default.ui-corner-all').addClass('light-blue-background');
        //End - Added by Viral Kadiya on 17/11/2014 to resolve PL ticket #947.

    });


    //<--- End Document.ready event  --->

    $("#btnCancel").click(function () {
        if ($('#PlanLineItemId').val() != '0') {
            CancelEvent();
            $("#successMessageViewLineItem").slideUp(50);
            $("#errorMessageEditLineitem").slideUp(50);
            $('#txtTitle').val($('#lblLineitemTitle').text());
        }
        else {
            $('.close-x-big-icon').trigger('click');
        }
    });

    function CancelEvent() {
        $("#hdnLineitemOpt").val("View");
        loadReview('@Model.PlanLineItemId', "Setup");
        $("#btnEditlineItem").css("display", "block");
        $("#AddForm").css("display", "block");
        $("#divDeleteProgram").css("display", "block");
        $('#txtTitle').css('display', 'none');
        $('#lblLineitemTitle').css('display', 'block');
        $("#lblLineitemTitle").removeAttr("style");
    }
    $(".alert").find(".close").on("click", function (e) {
        e.stopPropagation();
        e.preventDefault();
        $(this).closest(".alert").slideUp(300);/*SlideUp value change 400 to 300 by Mitesh Vaishnav on 04 july 2014*/
    });
    function ShowError(value) {
        $("#modal-container-186470").scrollTop(0);
        $("#successMessageViewLineItem").slideUp(400);
        $("#spanSuccessMessageViewLineitem").empty();
        $("#errorMessageEditLineitem").slideDown(400);
        $("#spanMessageEditLineitem").empty();
        $("#spanMessageEditLineitem").html(value);
    }
    $("#txtLineItemCost").keyup(function () {
        var LineItemBudgetValue = ReplaceCC($("#txtLineItemCost").val());
        if (LineItemBudgetValue == '' || typeof LineItemBudgetValue == 'undefined') {
            $("#txtLineItemCost").val('$0')
        }
    });
    function SetupSaveLineitem() {

        var returnparameter = false;
        //  $("#save_LineItem").click(function () {
        var iserror = false;
        var lineItemTitle = htmlEncode($('#txtTitle').val());

        if ($('#txtTitle').val().toString().toLowerCase().trim() == '@Common.DefaultLineItemTitle.ToLower()' && $('#lblLineitemTitle').css('display') != 'block') {
            var errorMsg = "You can't use 'Other' as title.";
            ShowError(errorMsg);
            return false;
        }
        if ($('#txtTitle').val().toString().toLowerCase().trim() != '@Common.DefaultLineItemTitle.ToLower()') {
            $('form').find('input[type=text], select, textarea').each(function () {
                if ($(this).attr('require') == 'true') {
                    if ($(this).val() == '') {
                        $(this).addClass("error");
                        iserror = true;
                    }
                    else {
                        $(this).removeClass("error");
                    }
                }
            });

            //$('form').find('.sbSelector').each(function () {
            //    if ($(this).parent().prev().attr('require') == 'true') {
            //        if ($(this).text() == 'Please Select') {
            //            $(this).addClass("error");
            //            iserror = true;
            //        }
            //        else {
            //            $(this).removeClass("error");
            //        }
            //    }
            //});
            if (!($("#hdnInspectMode").val() == '@Enums.InspectPopupMode.Add.ToString()')) {
                var LineItemTypeValue = $('#LineItemTypeId').val();
                if (LineItemTypeValue == "") {
                    $('#btnMultiselect_LineItemTypeId').addClass("error");
                }
                else {
                    $('#btnMultiselect_LineItemTypeId').removeClass("error");
                }
            }
        }

        if (iserror) {
            ShowError("@RevenuePlanner.Helpers.Common.objCached.ValidateForEmptyField");
            return false;
        }

        //Added BY Komal Rawal for #1617
        _FieldMappingValues = [];
        for(var i=0;i<ListOfItmeCheck.Ids.length;i++)
        {
            _FieldMappingValues.push({
                Id: ListOfItmeCheck.Ids[i],
                Name: ListOfItmeCheck.values[i],
                Weightage: Weights.values[i] != '' ?  Weights.values[i] : '100',
            });
            //  var IsWeightError = $('#'+ Weights.txtId[i]).hasClass('error');

        }
        if(totalWeightage != 100)
        {
            ShowError('@Common.objCached.ValidateAttributeWeightSum'.replace('{0}', "Budget Account"));
            return false;
        }
        _FieldMappingValues = JSON.stringify(_FieldMappingValues);
        //End
        var regex = /(>|<)/m;

        var descriptionvalue = $("#txtDescription").val();
        if (descriptionvalue.search(regex) >= 0) {
            ShowError("@RevenuePlanner.Helpers.Common.objCached.InvalidCharacterofDescription");
            $("#txtDescription").addClass("error");
            return false;
        }

        $("#txtLineItemCost").val(ReplaceCC($("#txtLineItemCost").val()));
        document.getElementById("txtDescription").value = htmlEncode($('#txtDescription').val());
        var uId = $(window).attr('name');

        document.getElementById("hdnDescription").value = htmlEncode($('#txtDescription').val());
        $.ajax({
            type: 'POST',
            async: false,
            url: '@Url.Content("~/Inspect/SaveLineitem")',
            data: $("form").serialize() + '&title='+escape(lineItemTitle)+ '&FieldMappingValues=' + escape(_FieldMappingValues) + '&tacticId=@Model.PlanTacticId'+'&UserId='+uId,
            success: function (data) {
                if (data.returnURL != 'undefined' && data.returnURL == '#') {
                    window.location = '@Url.Content("~/Login/Index")';
                }
                else {
                    if (data.isSaved) {
                        var activeTab = $("#InspectTab li.active a").text()
                        var planLineItemId = $("#PlanLineItemId").val();
                        $("#successMessage").css("display", "block");
                        $("#spanMessageSuccess").empty();
                        $("#spanMessageSuccess").text(data.msg);
                        $("#errorMessageEditLineitem").css("display", "none");
                        var requestedModule = $("#hdnRedirectType").val();
                        var plancampaignId = 0;
                        var planProgramId = 0;
                        var planTacticId = 0;
                        $("#liActuals,#liBudget,#liSetup").bind('click');
                        if (planLineItemId == '0') {
                            planLineItemId = data.planLineitemID;
                        }
                        plancampaignId = data.planCampaignID;
                        planProgramId = data.planProgramID;
                        planTacticId = data.planTacticID;
                        $('#lblLineitemTitle').text(lineItemTitle);
                        if (inspectMode == '@Enums.InspectPopupMode.Add.ToString()') {
                            var ChangedTab = "Setup";
                            if (tabtext != "") {
                                ChangedTab = tabtext;
                            }
                            var inspectPopupMode = '@Enums.InspectPopupMode.Edit.ToString()';
                            if (ChangedTab == "Setup") {
                                inspectPopupMode = '@Enums.InspectPopupMode.ReadOnly.ToString()';
                            }
                            loadInspectPopup(planLineItemId, "@Convert.ToString(RevenuePlanner.Helpers.Enums.Section.LineItem).ToLower()", ChangedTab, inspectPopupMode, 0, requestedModule);
                            //RefreshCurrentTab(requestedModule, plancampaignId, planProgramId, planTacticId);
                        }
                        else{
                            //   loadInspectPopup(planLineItemId, "@Convert.ToString(RevenuePlanner.Helpers.Enums.Section.LineItem).ToLower()", activeTab, "@Enums.InspectPopupMode.ReadOnly.ToString()", 0, requestedModule);

                            if ("@Enums.InspectPopupRequestedModules.Budgeting.ToString()" == requestedModule) {
                                $("#hdnBudgetingExpandId").val("lineitem" + planLineItemId);
                                $("#hdnBudgetingIsSave").val("true");
                            }
                            else {
                                //RefreshCurrentTab(requestedModule, plancampaignId, planProgramId, planTacticId);    //// Added by Sohel Pathan on 29/10/2014 for Internal Review Points
                            }
                            returnparameter = true;
                        }
                    }
                    else {
                        ShowError(data.msg);
                        returnparameter = false;
                    }
                }
            }
        });
        //   });
        return returnparameter;
    }
</script>
