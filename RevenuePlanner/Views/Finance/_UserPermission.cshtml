@using RevenuePlanner.Helpers;
@model RevenuePlanner.Models.FinanceModel
@section nlFormContent{
    <link rel="stylesheet" href="@Url.Content("~/Content/css/NaturalLanguageForm/default.css")" type="text/css" />
    <link rel="stylesheet" href="@Url.Content("~/Content/css/NaturalLanguageForm/component.css")" type="text/css" />
    <script type="text/javascript" src="@Url.Content("~/Scripts/js/NaturalLanguageForm/modernizr.custom.js")"></script>
    <script type="text/javascript" src="@Url.Content("~/Scripts/js/NaturalLanguageForm/nlform.js?n=")@DateTime.Now"></script>
}

<script src="@Url.Content("~/Scripts/js/jquery-ui-1.11.4.min.js")"></script>

<link href="@Url.Content("~/Content/css/JquryUI/jquery-ui-1.8.21.custom.css")" rel="stylesheet" type="text/css" />
<style>
    
</style>
<div style="" class="finance-header user-per_wrapper">
    <div style="" id="DivFilterPer" class="finance-header-inner">
        <div style="" class="fin-head-left">
            <div style="float: left;" id="drpParentMain">
                <div id="nl-formUserChildFinance" class="nl-form-plan-title without-margin plantitle financetitle">
                    @Html.DropDownList("ddlUserChildFinance", new SelectList((System.Collections.IEnumerable)ViewBag.childbudgetlist, "Value", "Text"))
                    <div class="nl-overlay"></div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="fin-permission">
    <div class="permission-inner">
        <div class="user-list">
            <p>Add user to list</p>
            <div class="search-user">
                @Html.TextBox("Selectuser")
            </div>
        </div>
        <div id="tableNoData" style="width: 100%; clear: both; display: none; font-weight: bold; text-align: center">
            No data found.
        </div>
        <div class="user-table">
            <div id="SaveMsg" class="alert alert-success">
                <span class="x-icon pull-right" id="aclose"></span>
                <span>Changes saved.</span>
            </div>

            <p>Users with permission</p>
            <table id="userTable" class="table table-striped table-hover myteam">
                <thead>
                    <tr>
                        <th title="First Name">First Name
                        </th>
                        <th title="Last Name">Last Name
                        </th>

                        <th title="Role">Role
                        </th>
                        <th>Permission</th>
                    </tr>
                </thead>
                <tbody>

                    @if (ViewBag.FlagCondition == "View")
                    {

                        foreach (var item in Model.Userpermission)
                        {
                        <tr class="userrow">
                            <td title="@item.id" class="selectrec" style="display: none">@Html.DisplayFor(model => item.id)</td>
                            <td title="@item.FirstName">@Html.DisplayFor(model => item.FirstName)</td>
                            <td title="@item.LastName">@Html.DisplayFor(mode => item.LastName)</td>
                            <td>@Html.DisplayFor(model => item.Role)</td>
                              @if (item.Permission == 0)
                              {
                                     <td class="userDelete">
                                    <p>
                                        <input type="radio" id="vew-edit'@item.id'" checked="checked" name="@item.id" par="0"><label for="vew-edit_@item.id">View/Edit</label>
                                    </p>
                                    <p>
                                        <input type="radio" id="view-only'@item.id'"  name="@item.id" par="1"><label for="view-only_@item.id">view only</label>
                                    </p>
                                    <a href="#">
                                        <span title="Delete Member" class="x-icon hide pull-right"></span>
                                    </a>
                                </td>
                              }
                              else
                              {
                                 <td class="userDelete">
                                    <p>
                                        <input type="radio" id="vew-edit'@item.id'"  name="@item.id" par="0"><label for="vew-edit_@item.id">View/Edit</label>
                                    </p>
                                    <p>
                                        <input type="radio" id="view-only'@item.id'" checked="checked" name="@item.id" par="1"><label for="view-only_@item.id">view only</label>
                                    </p>
                                    <a href="#">
                                        <span title="Delete Member" class="x-icon hide pull-right"></span>
                                    </a>

                                </td>

                              }
                         @*   <td class="userDelete">
                                <p>
                                    <input type="radio" id="vew-edit'@item.id'" checked="checked" name="@item.id" par="0"><label for="vew-edit_@item.id">View/Edit</label>
                                </p>
                                <p>
                                    <input type="radio" id="view-only'@item.id'" checked="checked" name="@item.id" par="1"><label for="view-only_@item.id">view only</label>
                                </p>
                            </td>*@
                        </tr>
                        }
                    }
                    @if (ViewBag.FlagCondition == "Edit")
                    {
                        foreach (var item in Model.Userpermission)
                        {
                        <tr class="userrow">
                          
                            <td title="@item.id" class="selectrec" style="display: none">@Html.DisplayFor(model => item.id)</td>
                            <td title="@item.createdby" class="selectrec" style="display: none">@Html.DisplayFor(model => item.createdby)</td>
                            <td title="@item.FirstName">@Html.DisplayFor(model => item.FirstName)</td>
                            <td title="@item.LastName">@Html.DisplayFor(mode => item.LastName)</td>
                            <td>@Html.DisplayFor(model => item.Role)</td>
                            @if (item.Permission == 0)
                            {
                                <td class="userDelete">
                                    <p>
                                        <input type="radio" id="vew-edit'@item.id'" checked="checked" name="@item.id" par="0"><label for="vew-edit_@item.id">View/Edit</label>
                                    </p>
                                    <p>
                                        <input type="radio" id="view-only'@item.id'"  name="@item.id" par="1"><label for="view-only_@item.id">view only</label>
                                    </p>
                                    <a href="#" onclick="DeleteUsers('@item.id','@item.budgetID','@item.FirstName','@item.LastName');">
                                        <span title="Delete Member" class="x-icon hide pull-right"></span>
                                    </a>
                                </td>
                            }
                            else
                            {
                                
                                <td class="userDelete">
                                    <p>
                                        <input type="radio" id="vew-edit'@item.id'"  name="@item.id" par="0"><label for="vew-edit_@item.id">View/Edit</label>
                                    </p>
                                    <p>
                                        <input type="radio" id="view-only'@item.id'" checked="checked" name="@item.id" par="1"><label for="view-only_@item.id">view only</label>
                                    </p>
                                    <a href="#" onclick="DeleteUsers('@item.id','@item.budgetID','@item.FirstName','@item.LastName');">
                                        <span title="Delete Member" class="x-icon hide pull-right"></span>
                                    </a>

                                </td>
                                
                            }

                        </tr>
                        }
                    }


                </tbody>
            </table>
            <input id="btnsave" type="submit" class="btn btn-blue btn-save text-shadow-blue source-sans-proregular" title="Save Changes" value="Save Changes">
            <button id="btncancel" class="btn-link Cancel-button-center-popups" type="button">Cancel</button>
        </div>
    </div>
</div>

<div id="divDeletePopup" class="form-inspect-share hide fade height-auto popup-block margin_top0" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div>
        <form>
            <h2 class="primary-title source-sans-prosemibold resubmission_header">Deleting an item</h2>
            <label style="text-align: center; width: 100%;" class="resubmission_content">You are about to delete </label>
            <label id="lipname" style="text-align: center; width: 100%;" class="resubmission_content"></label>
            <label style="text-align: center; width: 100%;" class="resubmission_content">Do you want to proceed?</label>
            <input type="hidden" id="hdnsourceid" />
            <input type="hidden" id="hdndestid" />
            <button class="form-inspect-share-button btn btn-large bottom-margin-popups" type="button" id="proceed-button_DeleteItem">Proceed</button>
            <button id="cancel-button_DeleteItem" class="btn-link Cancel-button-center-popups" style="margin-left: 10.5%" type="button">Cancel</button>
        </form>
    </div>
</div>
<div id="divCancelPopup" class="form-inspect-share hide fade height-auto popup-block margin_top0" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div>
        <form>
            <label style="text-align: center; width: 100%;" class="resubmission_content">You have unsaved changes. Do you wish to leave this page and lose your work?</label>
            <button class="form-inspect-share-button btn btn-large bottom-margin-popups" type="button" id="proceed-button_Continue">Continue</button>
            <button id="cancel-button_Cancel" class="btn-link Cancel-button-center-popups" style="margin-left: 10.5%" type="button">Cancel</button>
        </form>
        @*  <form>
            <label style="text-align: center; width: 100%;" class="resubmission_content">Want to save your changes?</label>
            <button class="form-inspect-share-button btn btn-large bottom-margin-popups" type="button" id="proceed-button_Yes">Yes</button>
            <button id="cancel-button_Cancel" class="btn-link Cancel-button-center-popups" style="margin-left: 10.5%" type="button">Cancel</button>
        </form>*@
    </div>
</div>

<style type="text/css">
    .ui-state-focus
    {
        background: #F69C55!important;
    }
</style>


<script type="text/javascript">
    var nlformUserChildFinance;
    var _isDatabase = '';
    var isExist = false;
    var _id = '';
    var _budgetId = ''
    var _changedata = '';
    //var setwidth = '';
    $(function () {
        pageName = "UserPermission";

        var isView = '@ViewBag.FlagCondition';
        if (isView == "View") {
            $("#DivFilterPer").hide();
            $(".user-list").hide();
            $("#btnsave").hide();
            $("#btncancel").hide();
            $(".user-table").css("width", "100%");
            $(".user-table input").attr("disabled", true);
            $("#divFinanceBack").show();
        }
        $("#lblfinanceTitle").text('Finance (Permissions)');
        $('#SaveMsg').hide();
        $("#DivFilter").css('display', 'none');
        $('#divDeletePopup').modal("hide");


        nlformUserChildFinance = new NLForm(document.getElementById('nl-formUserChildFinance'));

        InspectBudgetPermissionRow();


        //var width = $(".user-list").width();
        //setwidth = width +"px";

        var PrevSelectVal = $("#nl-formUserChildFinance option:selected");
        $('#nl-formUserChildFinance').find('li').click(function (e) {
            var $thisId = $(this).val();
            $("#nl-formUserChildFinance li").each(function () {
                if ($(this).val().toString() != $(PrevSelectVal).val()) {
                    var tss = $(this).removeClass('nl-dd-checked');

                }
            });
            $(this).addClass('nl-dd-checked');
            Bindtable($thisId);
            $("#divFinanceBack").show();

        });

        function Bindtable($thisId) {
            $.ajax({
                url: '@Url.Content("~/Finance/DrpFilterByBudget/")',
                type: 'POST',
                dataType: "json",
                data: { BudgetId: $thisId, level: 0, FlagCondition: 'Edit' },
                success: function (Data) {
                    $("#userTable tbody").html("");
                    if (Data.length == "0") {
                        $(".user-table").hide();
                        $("#tableNoData").show();
                        return false;
                    }
                    else {
                        var data = Data;
                        var html = "";
                        for (var i = 0; i < data.length; i++) {
                            var html = "";
                            if (data[i].Permission == 0) {
                                html = '<p><input type="radio" id="vew-edit' + data[i].id + '" checked="checked" name="permission' + "_" + data[i].id + '"  par=0><label for="vew-edi' + data[i].id + 't">View/Edit</label></p><p> <input type="radio" id="view-only' + data[i].id + '"  name="permission' + "_" + data[i].id + '" par=1 /><label for="view-only' + data[i].id + '">view only</label></p>';
                            }
                            else {
                                html = '<p><input type="radio" id="vew-edit' + data[i].id + '" name="permission' + "_" + data[i].id + '"  par=0><label for="vew-edit' + data[i].id + '">View/Edit</label></p><p> <input type="radio" checked="checked" id="view-only' + data[i].id + '"  name="permission' + "_" + data[i].id + '" par=1 /><label for="view-only' + data[i].id + '">view only</label></p>';
                            }
                            $("#userTable").append('<tr class="userrow"><td titile="UserID" class="selectrec" style="display:none">' + data[i].id + '</td><td title=' + data[i].FirstName + '>' + data[i].FirstName + '</td><td title=' + data[i].LastName + '>' + data[i].LastName + '</td><td>' + data[i].Role +
                             '</td><td class="userDelete">' + html + ' <a href="Finance/DeleteUser/' + data[i].id + '")"> <span id="deletemember" title="Delete Member" class="x-icon hide pull-right"></span></a></td></tr>');
                        }
                        $("#tableNoData").hide();
                        $(".user-table").show();
                    }
                },
                error: function () {
                }
            })
        }


        if ('@ViewBag.NoRecord' == "NoRecord") {
            $('.user-table').hide();
            $("#tableNoData").css('display', 'block');
        }
        $(".x-icon").click(function (e) {
            //e.preventDefault();
            $(this).closest(".alert").slideUp(300);
        });

        var row;
        $('#userTable').on('click', '#deletemember', function () {
           
            var Name = $(this).closest('tr').find('td').eq(1).text() + " " + $(this).closest('tr').find('td').eq(2).text() + ".";
            $("#divDeletePopup h2").text('Deleteing a user');
            $("#lipname").html(Name);
            $("#divDeletePopup").modal('show');
            row = $(this).closest('tr');
            return false;
        });
        $('#cancel-button_DeleteItem').on("click", function () {
            $('#divDeletePopup').modal("hide");
            return false;
        });
        $('#proceed-button_DeleteItem').on("click", function () {
            if (_isDatabase == "Fromdatabase") {
                Userdelete(_id, _budgetId);
            }
            else {
                var y = $(row).remove();
            }
            $('#divDeletePopup').modal("hide");
            $("#SaveMsg").show();
            $("#SaveMsg").find('span').last().text('User Deleted SuccessFully !');
        });

        $("#btncancel").click(function () {
            if (_changedata == 'Change') {
                $("#divCancelPopup").modal('show');
            }
            else {
                FinanceBack();
            }
        })

        $("#proceed-button_Continue").click(function () {
            FinanceBack();
            $("#divCancelPopup").modal('hide');
            // return false;
        });

        //$("#proceed-button_Yes").click(function () {
        //    $("#btnsave").trigger('click');
        //    FinanceBack();
        //    $("#divCancelPopup").modal('hide');
        //    // return false;
        //});

        $("#cancel-button_Cancel").click(function () {
            $("#divCancelPopup").modal('hide');
            return false;
        })


        $('#Selectuser').autocomplete({
            source: function (request, response) {
                $.getJSON("/Finance/getData?term=" + request.term, function (data) {
                    myApp.hidePleaseWait();
                    response($.map(data, function (item) {

                        return { label: item.UserId, value: item.DisplayName, title: item.JobTitle };
                    }))

                });
                myApp.hidePleaseWait();
            },
            minLength: 1,
            //delay: 50,
            select: function (event, ui) {

                $this = ui.item.label;
                getrecord($this);
            }
        }).data('ui-autocomplete')._renderItem = function (ul, item) {
            return $("<li>")
                .append("<div><div class='add-interest'><div>" + item.value + "</div><div>" + item.title + "</div><div>" + " " + '<img src="/Content/images/icon-plus_in_circle.png" style="float:right"></div>' + "</div>")
                .appendTo(ul.addClass('user_permission_list'));
        };

        $("#divFinanceBack").css("display", "block");
        function getrecord(_userid) {
            $('.user-table').show();
            $('#tableNoData').hide();
            checkExistingUser(_userid);
            var t = _UserBudgetId;
            _changedata = "Change";

            if (isExist) {
                return false;
            }
            else {
                $.ajax({
                    url: '@Url.Content("~/Finance/GetuserRecord/")',
                    type: 'POST',
                    dataType: "json",
                    data: { Id: _userid },
                    success: function (data) {
                       
                        $("#SaveMsg").hide();
                        $("#Selectuser").val('');
                        $("#userTable").append('<tr class="userrow"><td titile="UserID" class="selectrec" style="display:none">' + data.UserId + '</td><td title=' + data.FirstName + '>' + data.FirstName + '</td><td title=' + data.LastName + '>' + data.LastName + '</td><td>' + data.RoleTitle +
                            '</td><td class="userDelete"> <p><input type="radio" id="vew-edit" checked="checked" name="permission' + "_" + data.UserId + '"  par=0><label for="vew-edit' + data.UserId + '">View/Edit</label></p><p> <input type="radio" id="view-only"  name="permission' + "_" + data.UserId + '" par=1 /><label for="view-only' + data.UserId + '">view only</label></p><a href="Finance/DeleteUser/' + data.UserId + '"> <span id="deletemember" title="Delete Member" class="x-icon hide pull-right"></span></a></td></tr>');
                        InspectBudgetPermissionRow();
                    }
                })

            }

        }

        function checkExistingUser(_userid) {
            isExist = false;
            $("#userTable tbody tr").each(function () {
                var Id = $(this).find('td:first').text();
                if (!isExist) {
                    if (Id == _userid) {
                        isExist = true;
                    }
                    else {
                        isExist = false;
                    }
                }

            })
        }

        function checklogedUser() {
            $("#userTable tbody tr").each(function () {
                var Id = $(this).find('td:first').text();
                if (Id == '@Sessions.User.UserId') {

                    $(this).css("cursor", 'not-allowed');
                }
            })
        }


        $("#btnsave").click(function () {
            var emp = [];
            var table = $("#userTable tbody");

            var DrpId = $("#nl-formUserChildFinance li.nl-dd-checked").val()


            if ($("#userTable tbody tr").length > 0) {
                $("#userTable tbody tr").each(function () {

                    var _CodeFlag;
                    var userid = $(this).find('td:first').text();
                    $(this).find("input[type='radio']:checked").each(function () {

                        _CodeFlag = $(this).attr("par");
                    });
                    emp.push({ UserId: userid.toString(), PermisssionCode: parseInt(_CodeFlag) });
                });
            }
            else {
                return false;
            }
            emp = JSON.stringify({ 'UserData': emp, 'ID': DrpId });
            $.ajax({
                //traditional: true,
                url: '@Url.Action("SaveDetail", "Finance")',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                data: emp,
                success: function (data) {
                    if (data) {
                        $("#SaveMsg").find('span').last().text('Changes saved.');
                        $('#SaveMsg').show();
                    }
                },
                error: function () {
                    $('#SaveMsg').hide();
                }
            });
        })
        checklogedUser();
    })

    function InspectBudgetPermissionRow() {
        $("#nl-formUserChildFinance li").each(function () {
            $("#userTable tbody tr").each(function () {
          

                var Id = $(this).find('td:first').text();
                var CreatedbyId = $(this).find('td').eq(1).text();
                if (Id == '@Sessions.User.UserId') {

                    $(this).find('td,input,span,a').attr("disabled", "disabled");
                    $(this).find('a').removeAttr("onclick");
                    $(this).find('a').removeAttr('href', '')
                    $(this).find('span').attr('id', '')
                }
                if (CreatedbyId == Id) {
                    $(this).find('td,input,span,a').attr("disabled", "disabled");
                    $(this).find('a').removeAttr("onclick");
                }

            })
            var y = $(this).val();
            $(this).removeClass('nl-dd-checked');
            if (_UserBudgetId == $(this).val()) {
                $(this).addClass('nl-dd-checked');
                $(this).parent().parent().find('a').text($(this).text());
            }
        });
    }


    function Userdelete(id, budgetID) {
        $.ajax({
            url: '@Url.Action("Delete", "Finance")',
            type: 'POST',
            data: { id: id, budgetID: budgetID },
            success: function (data) {
                if (data.Flag) {
                    $("#userTable tbody tr").each(function () {
                        var Id = $(this).find('td:first').text();
                        if (Id == id) {
                            $this = $(this).closest('tr').remove();
                        }
                    });

                }

            },
            error: function () {

            }
        });
    }

    function DeleteUsers(id, budgetID, firsname, lastname) {
        _isDatabase = "Fromdatabase";
        var name = firsname + " " + lastname + " " + ".";
        $("#divDeletePopup h2").text('Deleteing a user');
        $("#lipname").html(name);
        $("#divDeletePopup").modal('show');
        _id = id;
        _budgetId = budgetID;
    }

</script>
